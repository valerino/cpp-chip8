//
// Created by valerino on 09/11/2017.
//

#include <vuelib.h>
#include <assert.h>
#include "CMemory.h"
#include "CFile.h"

/*
 * standard chip8 fonts
 */
uint8_t g_chip8_fonts[] = {
    0xF0 , 0x90 , 0x90 , 0x90 , 0xF0 ,
    0x60 , 0xE0 , 0x60 , 0x60 , 0xF0 ,
    0x60 , 0x90 , 0x20 , 0x40 , 0xF0 ,
    0xF0 , 0x10 , 0xF0 , 0x10 , 0xF0 ,
    0x90 , 0x90 , 0xF0 , 0x10 , 0x10 ,
    0xF0 , 0x80 , 0x60 , 0x10 , 0xE0 ,
    0xF0 , 0x80 , 0xF0 , 0x90 , 0xF0 ,
    0xF0 , 0x10 , 0x10 , 0x10 , 0x10 ,
    0xF0 , 0x90 , 0xF0 , 0x90 , 0xF0 ,
    0xF0 , 0x90 , 0xF0 , 0x10 , 0x10 ,
    0x60 , 0x90 , 0xF0 , 0x90 , 0x90 ,
    0xE0 , 0x90 , 0xE0 , 0x90 , 0xE0 ,
    0x70 , 0x80 , 0x80 , 0x80 , 0x70 ,
    0xE0 , 0x90 , 0x90 , 0x90 , 0xE0 ,
    0xF0 , 0x80 , 0xF0 , 0x80 , 0xF0 ,
    0xF0 , 0x80 , 0xF0 , 0x80 , 0x80
};

/*
 * super chip8 fonts
 */
uint8_t g_schip8_fonts[] =  {
    0x18 , 0x3C , 0x66 , 0x66 , 0x66 , 0x66 , 0x66 , 0x66 , 0x3C , 0x18 ,
    0x0c , 0x1c , 0x3c , 0x0c , 0x0c , 0x0c , 0x0c , 0x0c , 0x3e , 0x3e ,
    0x3c , 0x7e , 0x66 , 0x06 , 0x0e , 0x1c , 0x38 , 0x70 , 0x7e , 0x7e ,
    0x3c , 0x7e , 0x66 , 0x06 , 0x1c , 0x1e , 0x06 , 0x66 , 0x7e , 0x3c ,
    0x0c , 0x1c , 0x1c , 0x3c , 0x2c , 0x6e , 0x7e , 0x0c , 0x0c , 0x1e ,
    0x7E , 0x7E , 0x60 , 0x60 , 0x7c , 0x3E , 0x06 , 0x66 , 0x7C , 0x38 ,
    0x1c , 0x3c , 0x70 , 0x60 , 0x7C , 0x66 , 0x66 , 0x66 , 0x3C , 0x18 ,
    0x7E , 0x7E , 0x06 , 0x06 , 0x0c , 0x1c , 0x38 , 0x30 , 0x30 , 0x30 ,
    0x18 , 0x3c , 0x66 , 0x66 , 0x3c , 0x7E , 0x66 , 0x66 , 0x7e , 0x3C ,
    0x3c , 0x7E , 0x66 , 0x66 , 0x66 , 0x3E , 0x06 , 0x0E , 0x3C , 0x38 ,
    0x18 , 0x18 , 0x3c , 0x24 , 0x24 , 0x66 , 0x7E , 0x66 , 0x66 , 0x66 ,
    0x7C , 0x7E , 0x66 , 0x66 , 0x7C , 0x7E , 0x66 , 0x66 , 0x7E , 0x7C ,
    0x1C , 0x3E , 0x76 , 0x60 , 0x60 , 0x60 , 0x60 , 0x76 , 0x3E , 0x1C ,
    0x7C , 0x7E , 0x66 , 0x66 , 0x66 , 0x66 , 0x66 , 0x66 , 0x7E , 0x7C ,
    0x7E , 0x7E , 0x60 , 0x60 , 0x7C , 0x7C , 0x60 , 0x60 , 0x7E , 0x7E ,
    0x7E , 0x7E , 0x60 , 0x60 , 0x7C , 0x7C , 0x60 , 0x60 , 0x60 , 0x60
};

CMemory::CMemory(CConfiguration *cfg,
                 const char *rom_path)
    : m_mem{NULL} {

  // allocate memory (4kb)
  m_mem = (uint8_t *)CMem::alloc(CHIP8_MEMORY_SIZE);

  // load game rom
  uint32_t game_size;
  uint8_t *game = (uint8_t *)CFile::to_buffer(rom_path, &game_size);
  if (!game) {
    // game file not found, halt!
    CMem::free(game);
    throw std::system_error(ENOENT, std::generic_category(),
                            std::string("can't find rom: ") +
                                std::string(rom_path));
  }
  assert(game_size <= (CHIP8_MEMORY_SIZE - INTERPRETER_MAX_SIZE));


  // charsets starts at 0, first chip8 then superchip8 (0x200 free space)
  // this is up to the developer where to store the charset, btw.
  memcpy(m_mem, g_chip8_fonts, sizeof(g_chip8_fonts));
  memcpy(m_mem+sizeof(g_chip8_fonts), g_schip8_fonts, sizeof(g_schip8_fonts));

  // copy game rom
  uint8_t *start_address =
      (cfg->get<std::string>("mode") == "eti660" ? m_mem + ETI660_START_ADDRESS
                                                 : m_mem + CHIP8_START_ADDRESS);
  memcpy(start_address, game, game_size);

  CMem::free(game);
}

CMemory::~CMemory() { CMem::free(m_mem); }
uint16_t CMemory::get_word(uint16_t address) {
  return htons(*((u_int16_t *)(m_mem + address)));
}

void CMemory::put_word(uint16_t address, uint16_t w) {
  *((u_int16_t *)(m_mem + address)) = htons(w);
}

uint8_t CMemory::get_byte(uint16_t address) { return *(m_mem + address); }
void CMemory::put_byte(uint16_t address, uint8_t b) { *(m_mem + address) = b; }
std::vector<uint8_t> CMemory::get_bytes(uint16_t address, uint16_t size) {
  return std::vector<uint8_t>((m_mem + address), (m_mem + address + size));
}
void CMemory::put_bytes(uint16_t address, std::vector<uint8_t> b) {
  memcpy((m_mem + address), b.data(), b.size());
}
uint16_t CMemory::schip8_charset_offset() {
  return sizeof(g_chip8_fonts);
}
